rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Função auxiliar para verificar autenticação
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Função auxiliar para obter dados do usuário
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    // Função auxiliar para verificar role
    function hasRole(role) {
      return isAuthenticated() && getUserData().role == role;
    }
    
    // Função auxiliar para verificar se é o próprio usuário
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Função auxiliar para verificar se é mentor ou gestor
    function isMentorOrGestor() {
      return hasRole('mentor') || hasRole('gestor');
    }
    
    // ============================================
    // USERS
    // ============================================
    match /users/{userId} {
      // Qualquer usuário autenticado pode ler documentos de users (necessário para o ranking)
      // Isso permite ver nome e foto de outros alunos no ranking
      allow read: if isAuthenticated();
      
      // Apenas o próprio usuário pode atualizar seus dados básicos
      // Mentor e Gestor também podem atualizar dados de usuários
      allow update: if isOwner(userId) && 
                       !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'uid']);
      allow update: if isMentorOrGestor();
      
      // Permitir criação durante cadastro de aluno
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow delete: if false;
    }
    
    // ============================================
    // GESTORES
    // ============================================
    match /gestores/{gestorId} {
      allow read: if hasRole('gestor') && isOwner(gestorId);
      allow write: if false; // Apenas via Cloud Functions
    }
    
    // ============================================
    // MENTORES
    // ============================================
    match /mentores/{mentorId} {
      // Gestor pode ler todos os mentores
      allow read: if hasRole('gestor');
      
      // Mentor pode ler seus próprios dados
      allow read: if hasRole('mentor') && isOwner(mentorId);
      
      // Apenas gestor pode criar/atualizar/deletar mentores (via Cloud Functions)
      allow write: if false;
      
      // Anotações do mentor sobre alunos
      match /anotacoes/{anotacaoId} {
        allow read, write: if hasRole('mentor') && isOwner(mentorId);
      }
    }
    
    // ============================================
    // ALUNOS
    // ============================================
    match /alunos/{alunoId} {
      // Gestor pode ler e escrever todos os alunos
      allow read, write: if hasRole('gestor');
      
      // Mentor pode ler e escrever todos os alunos
      allow read, write: if hasRole('mentor');
      
      // Aluno pode ler dados de outros alunos (necessário para o ranking)
      allow read: if hasRole('aluno');
      
      // Aluno pode atualizar seu perfil (exceto campos críticos)
      allow update: if hasRole('aluno') && 
                       isOwner(alunoId) && 
                       !request.resource.data.diff(resource.data).affectedKeys().hasAny(['userId', 'mentorId', 'ativo']);
      
      // Permitir criação durante cadastro (usuário autenticado criando seu próprio documento)
      allow create: if isAuthenticated() && request.auth.uid == alunoId;
      
      // Deleção apenas via Cloud Functions ou por mentor/gestor
      allow delete: if isMentorOrGestor();
      
      // ============================================
      // ESTUDOS (subcoleção)
      // ============================================
      match /estudos/{estudoId} {
        // Aluno pode ler, criar, atualizar e deletar seus próprios estudos
        allow read, create, update, delete: if hasRole('aluno') && isOwner(alunoId);
        
        // Mentor pode ler e escrever estudos de qualquer aluno
        allow read, create, update, delete: if hasRole('mentor');
        
        // Gestor pode ler e escrever todos os estudos
        allow read, create, update, delete: if hasRole('gestor');
      }
      
      // ============================================
      // SIMULADOS (subcoleção)
      // ============================================
      match /simulados/{simuladoId} {
        // Aluno pode ler, criar, atualizar e deletar seus próprios simulados
        allow read, create, update, delete: if hasRole('aluno') && isOwner(alunoId);
        
        // Mentor pode ler e escrever simulados de qualquer aluno
        allow read, create, update, delete: if hasRole('mentor');
        
        // Gestor pode ler e escrever todos os simulados
        allow read, create, update, delete: if hasRole('gestor');
      }
      
      // ============================================
      // HORÁRIOS (subcoleção)
      // ============================================
      match /horarios/{horarioId} {
        // Aluno pode gerenciar seu cronograma
        allow read, create, update, delete: if hasRole('aluno') && isOwner(alunoId);
        
        // Mentor pode ler e escrever horários de qualquer aluno
        allow read, create, update, delete: if hasRole('mentor');
        
        // Gestor pode ler e escrever todos os horários
        allow read, create, update, delete: if hasRole('gestor');
      }
      
      // ============================================
      // CONTEÚDOS (subcoleção)
      // ============================================
      match /conteudos/{conteudoId} {
        // Aluno pode gerenciar seu progresso de conteúdos
        allow read, create, update, delete: if hasRole('aluno') && isOwner(alunoId);
        
        // Mentor pode ler e escrever conteúdos de qualquer aluno
        allow read, create, update, delete: if hasRole('mentor');
        
        // Gestor pode ler e escrever todos os conteúdos
        allow read, create, update, delete: if hasRole('gestor');
      }
      
      // ============================================
      // TEMPLATES (subcoleção)
      // ============================================
      match /templates/{templateId} {
        // Aluno pode gerenciar seus templates de cronograma
        allow read, create, update, delete: if hasRole('aluno') && isOwner(alunoId);
        
        // Mentor pode ler e escrever templates de qualquer aluno
        allow read, create, update, delete: if hasRole('mentor');
        
        // Gestor pode ler e escrever todos os templates
        allow read, create, update, delete: if hasRole('gestor');
      }
      
      // ============================================
      // NOTIFICAÇÕES (subcoleção)
      // ============================================
      match /notificacoes/{notificacaoId} {
        // Aluno pode ler, atualizar e deletar suas próprias notificações
        allow read, update, delete: if hasRole('aluno') && isOwner(alunoId);
        
        // Mentor pode ler e escrever notificações de qualquer aluno
        allow read, create, update, delete: if hasRole('mentor');
        
        // Gestor pode ler e escrever todas as notificações
        allow read, create, update, delete: if hasRole('gestor');
      }
      
      // ============================================
      // METAS (subcoleção)
      // ============================================
      match /metas/{metaId} {
        // Aluno pode gerenciar suas próprias metas
        allow read, create, update, delete: if hasRole('aluno') && isOwner(alunoId);
        
        // Mentor pode ler e escrever metas de qualquer aluno
        allow read, create, update, delete: if hasRole('mentor');
        
        // Gestor pode ler e escrever todas as metas
        allow read, create, update, delete: if hasRole('gestor');
      }
      
      // ============================================
      // CONTEÚDOS_PROGRESSO (subcoleção)
      // ============================================
      match /conteudos_progresso/{progressoId} {
        // Aluno pode gerenciar seu progresso de conteúdos
        allow read, create, update, delete: if hasRole('aluno') && isOwner(alunoId);
        
        // Mentor pode ler e escrever progresso de qualquer aluno
        allow read, create, update, delete: if hasRole('mentor');
        
        // Gestor pode ler e escrever todo o progresso
        allow read, create, update, delete: if hasRole('gestor');
      }
      
      // ============================================
      // PLANOS DE AÇÃO (subcoleção)
      // ============================================
      match /planosAcao/{planoId} {
        // Aluno pode gerenciar seus próprios planos de ação
        allow read, create, update, delete: if hasRole('aluno') && isOwner(alunoId);
        
        // Mentor pode ler e escrever planos de ação de qualquer aluno
        allow read, create, update, delete: if hasRole('mentor');
        
        // Gestor pode ler e escrever todos os planos de ação
        allow read, create, update, delete: if hasRole('gestor');
      }
      
      // ============================================
      // DIAGNÓSTICO DE PERFIL (subcoleção)
      // ============================================
      match /diagnostico/{diagnosticoId} {
        // Aluno pode gerenciar seu próprio diagnóstico de perfil
        allow read, create, update, delete: if hasRole('aluno') && isOwner(alunoId);
        
        // Mentor pode ler e escrever diagnóstico de qualquer aluno
        allow read, create, update, delete: if hasRole('mentor');
        
        // Gestor pode ler e escrever todos os diagnósticos
        allow read, create, update, delete: if hasRole('gestor');
      }
      
      // ============================================
      // AUTODIAGNÓSTICOS (subcoleção)
      // ============================================
      match /autodiagnosticos/{autodiagnosticoId} {
        // Aluno pode gerenciar seus próprios autodiagnósticos
        allow read, create, update, delete: if hasRole('aluno') && isOwner(alunoId);
        
        // Mentor pode ler e escrever autodiagnósticos de qualquer aluno
        allow read, create, update, delete: if hasRole('mentor');
        
        // Gestor pode ler e escrever todos os autodiagnósticos
        allow read, create, update, delete: if hasRole('gestor');
      }
      
      // ============================================
      // REDAÇÕES (subcoleção)
      // ============================================
      match /redacoes/{redacaoId} {
        // Aluno pode gerenciar suas próprias redações
        allow read, create, update, delete: if hasRole('aluno') && isOwner(alunoId);
        
        // Mentor pode ler e escrever redações de qualquer aluno
        allow read, create, update, delete: if hasRole('mentor');
        
        // Gestor pode ler e escrever todas as redações
        allow read, create, update, delete: if hasRole('gestor');
      }
      
      // ============================================
      // CONFIGURAÇÕES (subcoleção)
      // ============================================
      match /configuracoes/{configId} {
        // Aluno pode gerenciar suas próprias configurações
        allow read, create, update, delete: if hasRole('aluno') && isOwner(alunoId);
        
        // Mentor pode ler e escrever configurações de qualquer aluno
        allow read, create, update, delete: if hasRole('mentor');
        
        // Gestor pode ler e escrever todas as configurações
        allow read, create, update, delete: if hasRole('gestor');
      }
      
      // ============================================
      // DIÁRIO EMOCIONAL (subcoleção)
      // ============================================
      match /diario_emocional/{diarioId} {
        // Aluno pode gerenciar seu próprio diário emocional
        allow read, create, update, delete: if hasRole('aluno') && isOwner(alunoId);
        
        // Mentor pode ler e escrever diário emocional de qualquer aluno
        allow read, create, update, delete: if hasRole('mentor');
        
        // Gestor pode ler e escrever todos os diários emocionais
        allow read, create, update, delete: if hasRole('gestor');
      }
      
      // ============================================
      // CRONOGRAMA DINÂMICO (subcoleção)
      // ============================================
      match /cronograma/{cronogramaId} {
        // Aluno pode gerenciar seu próprio cronograma dinâmico
        allow read, create, update, delete: if hasRole('aluno') && isOwner(alunoId);
        
        // Mentor pode ler e escrever cronograma de qualquer aluno
        allow read, create, update, delete: if hasRole('mentor');
        
        // Gestor pode ler e escrever todos os cronogramas
        allow read, create, update, delete: if hasRole('gestor');
      }
      
      // ============================================
      // CRONOGRAMA LISTA (subcoleção - to-do list style)
      // ============================================
      match /cronograma_lista/{atividadeId} {
        // Aluno pode gerenciar sua própria lista de atividades
        allow read, create, update, delete: if hasRole('aluno') && isOwner(alunoId);
        
        // Mentor pode ler e escrever lista de atividades de qualquer aluno
        allow read, create, update, delete: if hasRole('mentor');
        
        // Gestor pode ler e escrever todas as listas de atividades
        allow read, create, update, delete: if hasRole('gestor');
      }
      
      // ============================================
      // AGENDA (subcoleção - calendário mensal)
      // ============================================
      match /agenda/{atividadeId} {
        // Aluno pode gerenciar suas próprias atividades da agenda
        allow read, create, update, delete: if hasRole('aluno') && isOwner(alunoId);
        
        // Mentor pode ler e escrever agenda de qualquer aluno
        allow read, create, update, delete: if hasRole('mentor');
        
        // Gestor pode ler e escrever todas as agendas
        allow read, create, update, delete: if hasRole('gestor');
      }
      
      // ============================================
      // AGENDA CONFIG (subcoleção - configuração da agenda)
      // ============================================
      match /agenda_config/{configId} {
        // Aluno pode gerenciar sua própria configuração da agenda
        allow read, create, update, delete: if hasRole('aluno') && isOwner(alunoId);
        
        // Mentor pode ler e escrever configuração de qualquer aluno
        allow read, create, update, delete: if hasRole('mentor');
        
        // Gestor pode ler e escrever todas as configurações
        allow read, create, update, delete: if hasRole('gestor');
      }
    }
    
    // ============================================
    // RANKING (coleção principal)
    // ============================================
    match /ranking/{rankingId} {
      // Qualquer usuário autenticado pode ler o ranking (para ver todos os alunos)
      allow read: if isAuthenticated();
      
      // Aluno pode atualizar apenas seu próprio registro de ranking
      allow update: if hasRole('aluno') && isOwner(rankingId);
      
      // Mentor e Gestor podem ler e escrever qualquer registro de ranking
      allow read, create, update, delete: if isMentorOrGestor();
    }
    
    // ============================================
    // RANKING HISTÓRICO (coleção principal)
    // ============================================
    match /ranking_historico/{historicoId} {
      // Qualquer usuário autenticado pode ler o histórico
      allow read: if isAuthenticated();
      
      // Mentor e Gestor podem escrever no histórico
      allow write: if isMentorOrGestor();
    }
    
    // ============================================
    // CONFIGURAÇÃO DO DIAGNÓSTICO DE PERFIL (coleção principal)
    // ============================================
    match /diagnostico_perfil_config/{configId} {
      // Qualquer usuário autenticado pode ler a configuração
      allow read: if isAuthenticated();
      
      // Mentores e Gestores podem escrever
      allow write: if isMentorOrGestor();
    }
    
    // ============================================
    // CONTEÚDOS BASE (dados padrão das matérias)
    // ============================================
    match /conteudos_base/{materiaKey} {
      // Qualquer usuário autenticado pode ler
      allow read: if isAuthenticated();
      
      // Apenas mentores e gestores podem escrever
      allow write: if isMentorOrGestor();
    }
    
    // ============================================
    // METAS DO MENTOR
    // ============================================
    match /metas_mentor/{alunoId} {
      // Mentor e Gestor podem ler e escrever metas de qualquer aluno
      allow read, write: if isMentorOrGestor();
      
      // Aluno pode ler suas próprias metas definidas pelo mentor
      allow read: if hasRole('aluno') && isOwner(alunoId);
    }
    
    // ============================================
    // ALERTAS DO MENTOR
    // ============================================
    match /alertas_mentor/{mentorId} {
      // Apenas o próprio mentor pode ler e escrever suas configurações de alertas
      allow read, write: if hasRole('mentor') && isOwner(mentorId);
      
      // Gestor pode ler e escrever alertas de qualquer mentor
      allow read, write: if hasRole('gestor');
    }
    
    // ============================================
    // ANOTAÇÕES DO MENTOR SOBRE ALUNOS
    // ============================================
    match /anotacoes_mentor/{mentorId} {
      // Apenas o próprio mentor pode ler e escrever suas anotações
      allow read, write: if hasRole('mentor') && isOwner(mentorId);
      
      // Gestor pode ler e escrever anotações de qualquer mentor
      allow read, write: if hasRole('gestor');
      
      // Subcoleção de anotações por aluno
      match /alunos/{alunoId} {
        // Apenas o próprio mentor pode ler e escrever suas anotações
        allow read, write: if hasRole('mentor') && isOwner(mentorId);
        
        // Gestor pode ler e escrever anotações de qualquer mentor
        allow read, write: if hasRole('gestor');
        
        // Subcoleção de anotações individuais
        match /notas/{notaId} {
          // Apenas o próprio mentor pode ler e escrever suas anotações
          allow read, write: if hasRole('mentor') && isOwner(mentorId);
          
          // Gestor pode ler e escrever anotações de qualquer mentor
          allow read, write: if hasRole('gestor');
        }
      }
    }
    
    // ============================================
    // CONTEÚDOS CUSTOMIZADOS (tópicos personalizados)
    // ============================================
    match /conteudos_customizados/{materiaKey} {
      // Qualquer usuário autenticado pode ler
      allow read: if isAuthenticated();
      
      // Apenas mentores e gestores podem escrever
      allow write: if isMentorOrGestor();
      
      // Subcoleção de tópicos
      match /topicos/{topicoId} {
        // Qualquer usuário autenticado pode ler
        allow read: if isAuthenticated();
        
        // Apenas mentores e gestores podem escrever
        allow write: if isMentorOrGestor();
      }
    }
  }
}
